#include <Arduino.h>  
#include <Wire.h>  
#include <PinDefinitions.h>  

const uint8_t TEENSY_ADDR = 0x42;
unsigned long lastSend = 0;

enum Mode { SCAN_MODE, TELEMETRY_MODE };
Mode mode = TELEMETRY_MODE;

void setup() {
    Serial1.begin(115200);
    while (!Serial1);

    Wire.setSDA(PinDefs.SDA);
    Wire.setSCL(PinDefs.SCL);
    Wire.begin();
    Wire.setClock(100000); // I2C set to 400 kHz

    Serial1.println("I2C Scanner");
}

void runScan() {
    byte error;
    int nDevices = 0;
    Serial1.println("Scanning I2C...");
    for (byte addr = 1; addr < 127; addr++) {
      Wire.beginTransmission(addr);
      error = Wire.endTransmission();
      if (error == 0) {
        Serial1.print("Found device at 0x");
        Serial1.println(addr, HEX);
        nDevices++;
      }
    }
    if (nDevices == 0) Serial1.println("No devices found");
    else Serial1.println("Scan done");
  
    delay(1000);
}

void sendTelemetry() {
  const char msg[] = "WASSUP BEIJING";

  Wire.beginTransmission(TEENSY_ADDR);
  Wire.write((uint8_t*)msg, sizeof(msg));
  uint8_t result = Wire.endTransmission();

  if (result == 0) {
    Serial1.println("Sent telemetry to Teensy!");
    delay(1000);
  }
  else {
    Serial1.print("I2C send error: ");
    Serial1.println(result);
  }
}

void loop() {
  if (mode == SCAN_MODE) {
    runScan();
  } else if (mode == TELEMETRY_MODE) {
    if (millis() - lastSend >= 50) {  // send every 50 ms
      sendTelemetry();
      lastSend = millis();
    }
  }
}